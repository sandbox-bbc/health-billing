<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Healthcare Billing System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Toast -->
    <div id="toast" class="fixed top-4 right-4 bg-gray-900 text-white px-4 py-2 rounded-lg text-sm hidden"></div>

    <!-- Header -->
    <header class="bg-white border-b">
        <div class="max-w-5xl mx-auto px-6 py-4 flex justify-between items-center">
            <h1 class="text-lg font-semibold text-gray-900">Healthcare Billing</h1>
            <span id="status" class="text-sm text-gray-400">Connecting...</span>
        </div>
    </header>

    <!-- Main -->
    <main class="max-w-5xl mx-auto px-6 py-8">
        <!-- Tabs -->
        <div class="flex gap-1 mb-8 border-b">
            <button onclick="showTab('demo')" data-tab="demo" class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-blue-600 text-blue-600">Demo</button>
            <button onclick="showTab('patients')" data-tab="patients" class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700">Patients</button>
            <button onclick="showTab('doctors')" data-tab="doctors" class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700">Doctors</button>
            <button onclick="showTab('appointments')" data-tab="appointments" class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700">Appointments</button>
            <button onclick="showTab('bills')" data-tab="bills" class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700">Bills</button>
        </div>

        <!-- Demo Tab -->
        <div id="tab-demo" class="tab-content">
            <div class="bg-white rounded-lg border p-6 mb-6">
                <h2 class="text-lg font-semibold mb-1">Billing Workflow Demo</h2>
                <p class="text-gray-500 text-sm mb-6">Follow these steps to generate a bill</p>

                <!-- Step 1 -->
                <div class="mb-6 pb-6 border-b">
                    <div class="flex items-center gap-2 mb-3">
                        <span class="w-6 h-6 rounded-full bg-blue-100 text-blue-600 text-xs flex items-center justify-center font-medium">1</span>
                        <span class="font-medium">Create Doctor</span>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-3">
                        <input id="d-fn" value="Sarah" placeholder="First Name" class="border rounded px-3 py-2 text-sm">
                        <input id="d-ln" value="Johnson" placeholder="Last Name" class="border rounded px-3 py-2 text-sm">
                        <select id="d-sp" class="border rounded px-3 py-2 text-sm">
                            <option value="CARDIO">Cardiology</option>
                            <option value="ORTHO">Orthopedics</option>
                        </select>
                        <input id="d-sd" value="01/01/2000" placeholder="Start Date" class="border rounded px-3 py-2 text-sm">
                    </div>
                    <button onclick="createDoctor()" class="bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700">Create Doctor</button>
                    <span id="d-result" class="ml-3 text-sm text-green-600"></span>
                </div>

                <!-- Step 2 -->
                <div class="mb-6 pb-6 border-b opacity-50" id="step2">
                    <div class="flex items-center gap-2 mb-3">
                        <span class="w-6 h-6 rounded-full bg-gray-100 text-gray-400 text-xs flex items-center justify-center font-medium" id="s2-badge">2</span>
                        <span class="font-medium">Create Patient</span>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-3">
                        <input id="p-fn" value="Michael" placeholder="First Name" class="border rounded px-3 py-2 text-sm" disabled>
                        <input id="p-ln" value="Chen" placeholder="Last Name" class="border rounded px-3 py-2 text-sm" disabled>
                        <input id="p-dob" value="03/15/1985" placeholder="DOB (MM/DD/YYYY)" class="border rounded px-3 py-2 text-sm" disabled>
                        <input id="p-bin" value="123456" placeholder="Insurance BIN" class="border rounded px-3 py-2 text-sm" disabled>
                    </div>
                    <button onclick="createPatient()" id="btn2" class="bg-gray-300 text-gray-500 px-4 py-2 rounded text-sm cursor-not-allowed" disabled>Create Patient</button>
                    <span id="p-result" class="ml-3 text-sm text-green-600"></span>
                </div>

                <!-- Step 3 -->
                <div class="mb-6 pb-6 border-b opacity-50" id="step3">
                    <div class="flex items-center gap-2 mb-3">
                        <span class="w-6 h-6 rounded-full bg-gray-100 text-gray-400 text-xs flex items-center justify-center font-medium" id="s3-badge">3</span>
                        <span class="font-medium">Schedule Appointment</span>
                    </div>
                    <button onclick="createAppointment()" id="btn3" class="bg-gray-300 text-gray-500 px-4 py-2 rounded text-sm cursor-not-allowed" disabled>Schedule for Today</button>
                    <span id="a-result" class="ml-3 text-sm text-green-600"></span>
                </div>

                <!-- Step 4 -->
                <div class="mb-6 pb-6 border-b opacity-50" id="step4">
                    <div class="flex items-center gap-2 mb-3">
                        <span class="w-6 h-6 rounded-full bg-gray-100 text-gray-400 text-xs flex items-center justify-center font-medium" id="s4-badge">4</span>
                        <span class="font-medium">Complete Appointment</span>
                    </div>
                    <button onclick="completeAppointment()" id="btn4" class="bg-gray-300 text-gray-500 px-4 py-2 rounded text-sm cursor-not-allowed" disabled>Mark Completed</button>
                    <span id="c-result" class="ml-3 text-sm text-green-600"></span>
                </div>

                <!-- Step 5 -->
                <div class="opacity-50" id="step5">
                    <div class="flex items-center gap-2 mb-3">
                        <span class="w-6 h-6 rounded-full bg-gray-100 text-gray-400 text-xs flex items-center justify-center font-medium" id="s5-badge">5</span>
                        <span class="font-medium">Generate Bill</span>
                    </div>
                    <button onclick="generateBill()" id="btn5" class="bg-gray-300 text-gray-500 px-4 py-2 rounded text-sm cursor-not-allowed" disabled>Generate Bill</button>
                </div>

                <!-- Bill Result -->
                <div id="bill-result" class="hidden mt-6 p-4 bg-green-50 border border-green-200 rounded-lg">
                    <h3 class="font-semibold text-green-800 mb-3">Bill Generated</h3>
                    <div id="bill-details" class="text-sm space-y-1"></div>
                </div>
            </div>

            <!-- Fee Reference -->
            <div class="bg-white rounded-lg border p-6">
                <h3 class="font-medium mb-3">Fee Reference</h3>
                <table class="w-full text-sm">
                    <thead><tr class="text-left text-gray-500"><th class="pb-2">Specialty</th><th class="pb-2">0-19 yrs</th><th class="pb-2">20-30 yrs</th><th class="pb-2">31+ yrs</th></tr></thead>
                    <tbody>
                        <tr><td class="py-1">Orthopedics</td><td>$800</td><td>$1,000</td><td>$1,500</td></tr>
                        <tr><td class="py-1">Cardiology</td><td>$1,000</td><td>$1,500</td><td>$2,000</td></tr>
                    </tbody>
                </table>
                <p class="text-xs text-gray-400 mt-3">Discount: min(prior visits, 10)% • GST: 12% • Insurance: 90% / Co-pay: 10%</p>
            </div>
        </div>

        <!-- Patients Tab -->
        <div id="tab-patients" class="tab-content hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold">Patients</h2>
                <button onclick="openModal('patient')" class="bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700">+ Add Patient</button>
            </div>
            <div id="patients-list" class="space-y-2"></div>
        </div>

        <!-- Doctors Tab -->
        <div id="tab-doctors" class="tab-content hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold">Doctors</h2>
                <button onclick="openModal('doctor')" class="bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700">+ Add Doctor</button>
            </div>
            <div id="doctors-list" class="space-y-2"></div>
        </div>

        <!-- Appointments Tab -->
        <div id="tab-appointments" class="tab-content hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold">Appointments</h2>
                <button onclick="openModal('appointment')" class="bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700">+ New Appointment</button>
            </div>
            <div id="appointments-list" class="space-y-2"></div>
        </div>

        <!-- Bills Tab -->
        <div id="tab-bills" class="tab-content hidden">
            <h2 class="text-lg font-semibold mb-4">Bills</h2>
            <div id="bills-list" class="space-y-2"></div>
        </div>
    </main>

    <!-- Modal -->
    <div id="modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center">
        <div class="bg-white rounded-lg p-6 w-full max-w-md m-4">
            <h3 id="modal-title" class="font-semibold mb-4"></h3>
            <form id="modal-form" class="space-y-3"></form>
            <div class="flex justify-end gap-2 mt-4">
                <button type="button" onclick="closeModal()" class="px-4 py-2 border rounded text-sm">Cancel</button>
                <button type="submit" form="modal-form" class="px-4 py-2 bg-blue-600 text-white rounded text-sm">Save</button>
            </div>
        </div>
    </div>

    <script>
        const API = '';
        let state = { doctorId: null, patientId: null, appointmentId: null };
        let data = { patients: [], doctors: [], appointments: [], bills: [] };

        // Init
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await fetch('/health');
                document.getElementById('status').textContent = '● Connected';
                document.getElementById('status').className = 'text-sm text-green-600';
            } catch { 
                document.getElementById('status').textContent = '● Disconnected';
                document.getElementById('status').className = 'text-sm text-red-500';
            }
            loadAll();
        });

        // Toast
        function toast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.remove('hidden');
            setTimeout(() => t.classList.add('hidden'), 3000);
        }

        // Tabs
        function showTab(name) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(el => {
                el.classList.remove('border-blue-600', 'text-blue-600');
                el.classList.add('border-transparent', 'text-gray-500');
            });
            document.getElementById(`tab-${name}`).classList.remove('hidden');
            document.querySelector(`[data-tab="${name}"]`).classList.add('border-blue-600', 'text-blue-600');
            document.querySelector(`[data-tab="${name}"]`).classList.remove('border-transparent', 'text-gray-500');
            if (name !== 'demo') loadAll();
        }

        // API
        async function api(path, opts = {}) {
            const res = await fetch(API + path, { headers: { 'Content-Type': 'application/json' }, ...opts });
            if (!res.ok) throw new Error((await res.json().catch(() => ({}))).message || 'Error');
            return res.status === 204 ? null : res.json();
        }

        async function loadAll() {
            try {
                [data.patients, data.doctors, data.appointments, data.bills] = await Promise.all([
                    api('/patients'), api('/doctors'), api('/appointments'), api('/bills')
                ]);
                render();
            } catch {}
        }

        function render() {
            // Patients
            document.getElementById('patients-list').innerHTML = data.patients.length ? data.patients.map(p => `
                <div class="bg-white border rounded p-4 flex justify-between items-center">
                    <div>
                        <div class="font-medium">${p.firstName} ${p.lastName}</div>
                        <div class="text-sm text-gray-500">DOB: ${p.dob} • Age: ${p.age}</div>
                    </div>
                    <button onclick="del('patients','${p.id}')" class="text-red-500 text-sm hover:underline">Delete</button>
                </div>
            `).join('') : '<p class="text-gray-400 text-sm">No patients yet</p>';

            // Doctors
            document.getElementById('doctors-list').innerHTML = data.doctors.length ? data.doctors.map(d => `
                <div class="bg-white border rounded p-4 flex justify-between items-center">
                    <div>
                        <div class="font-medium">Dr. ${d.firstName} ${d.lastName}</div>
                        <div class="text-sm text-gray-500">${d.specialty} • ${d.experienceYears} yrs exp</div>
                    </div>
                    <button onclick="del('doctors','${d.id}')" class="text-red-500 text-sm hover:underline">Delete</button>
                </div>
            `).join('') : '<p class="text-gray-400 text-sm">No doctors yet</p>';

            // Appointments
            document.getElementById('appointments-list').innerHTML = data.appointments.length ? data.appointments.map(a => {
                const p = data.patients.find(x => x.id === a.patientId);
                const d = data.doctors.find(x => x.id === a.doctorId);
                const statusClass = a.status === 'COMPLETED' ? 'bg-green-100 text-green-700' : a.status === 'CANCELLED' ? 'bg-red-100 text-red-700' : 'bg-blue-100 text-blue-700';
                return `
                <div class="bg-white border rounded p-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <span class="text-xs px-2 py-0.5 rounded ${statusClass}">${a.status}</span>
                            <div class="mt-1">${p ? p.firstName + ' ' + p.lastName : '?'} → Dr. ${d ? d.lastName : '?'}</div>
                            <div class="text-sm text-gray-500">${a.appointmentDate}</div>
                        </div>
                        <div class="flex gap-2">
                            ${a.status === 'SCHEDULED' ? `<button onclick="updateStatus('${a.id}','COMPLETED')" class="text-sm text-green-600 hover:underline">Complete</button>` : ''}
                            ${a.status === 'COMPLETED' ? `<button onclick="genBill('${a.id}')" class="text-sm text-blue-600 hover:underline">Generate Bill</button>` : ''}
                        </div>
                    </div>
                </div>`;
            }).join('') : '<p class="text-gray-400 text-sm">No appointments yet</p>';

            // Bills
            document.getElementById('bills-list').innerHTML = data.bills.length ? data.bills.map(b => `
                <div class="bg-white border rounded p-4">
                    <div class="flex justify-between">
                        <div>
                            <div class="font-medium">$${parseFloat(b.totalAmount).toFixed(2)}</div>
                            <div class="text-sm text-gray-500">Base: $${parseFloat(b.baseFee).toFixed(2)} • Discount: ${b.discountPercent}% • GST: $${parseFloat(b.gstAmount).toFixed(2)}</div>
                        </div>
                        <div class="text-right text-sm">
                            <div class="text-green-600">Insurance: $${parseFloat(b.insuranceAmount).toFixed(2)}</div>
                            <div class="text-orange-600">Co-pay: $${parseFloat(b.coPayAmount).toFixed(2)}</div>
                        </div>
                    </div>
                </div>
            `).join('') : '<p class="text-gray-400 text-sm">No bills yet</p>';
        }

        async function del(type, id) {
            if (!confirm('Delete?')) return;
            try { await api(`/${type}/${id}`, { method: 'DELETE' }); toast('Deleted'); loadAll(); }
            catch (e) { toast(e.message); }
        }

        async function updateStatus(id, status) {
            try { await api(`/appointments/${id}/status`, { method: 'PUT', body: JSON.stringify({ status }) }); toast('Updated'); loadAll(); }
            catch (e) { toast(e.message); }
        }

        async function genBill(id) {
            try { await api(`/bills?appointmentId=${id}`, { method: 'POST' }); toast('Bill generated'); loadAll(); }
            catch (e) { toast(e.message); }
        }

        // Demo functions
        function enableStep(n) {
            document.getElementById(`step${n}`).classList.remove('opacity-50');
            document.getElementById(`s${n}-badge`).className = 'w-6 h-6 rounded-full bg-blue-100 text-blue-600 text-xs flex items-center justify-center font-medium';
            const btn = document.getElementById(`btn${n}`);
            btn.disabled = false;
            btn.className = 'bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700';
            document.querySelectorAll(`#step${n} input`).forEach(i => i.disabled = false);
        }

        async function createDoctor() {
            try {
                const doc = await api('/doctors', { method: 'POST', body: JSON.stringify({
                    firstName: document.getElementById('d-fn').value,
                    lastName: document.getElementById('d-ln').value,
                    npiNo: 'NPI-' + Date.now(),
                    specialty: document.getElementById('d-sp').value,
                    practiceStartDate: document.getElementById('d-sd').value
                })});
                state.doctorId = doc.id;
                document.getElementById('d-result').textContent = `✓ Created (${doc.experienceYears} yrs exp)`;
                enableStep(2);
                loadAll();
            } catch (e) { toast(e.message); }
        }

        async function createPatient() {
            try {
                const pat = await api('/patients', { method: 'POST', body: JSON.stringify({
                    firstName: document.getElementById('p-fn').value,
                    lastName: document.getElementById('p-ln').value,
                    dob: document.getElementById('p-dob').value,
                    insurance: { binNo: document.getElementById('p-bin').value, pcnNo: 'PCN001', memberId: 'MEM' + Date.now() }
                })});
                state.patientId = pat.id;
                document.getElementById('p-result').textContent = `✓ Created (Age: ${pat.age})`;
                enableStep(3);
                loadAll();
            } catch (e) { toast(e.message); }
        }

        async function createAppointment() {
            const today = new Date();
            const date = `${String(today.getMonth()+1).padStart(2,'0')}/${String(today.getDate()).padStart(2,'0')}/${today.getFullYear()}`;
            try {
                const appt = await api('/appointments', { method: 'POST', body: JSON.stringify({
                    patientId: state.patientId, doctorId: state.doctorId, appointmentDate: date
                })});
                state.appointmentId = appt.id;
                document.getElementById('a-result').textContent = `✓ Scheduled for ${date}`;
                enableStep(4);
                loadAll();
            } catch (e) { toast(e.message); }
        }

        async function completeAppointment() {
            try {
                await api(`/appointments/${state.appointmentId}/status`, { method: 'PUT', body: JSON.stringify({ status: 'COMPLETED' }) });
                document.getElementById('c-result').textContent = '✓ Completed';
                enableStep(5);
                loadAll();
            } catch (e) { toast(e.message); }
        }

        async function generateBill() {
            try {
                const bill = await api(`/bills?appointmentId=${state.appointmentId}`, { method: 'POST' });
                document.getElementById('bill-result').classList.remove('hidden');
                document.getElementById('bill-details').innerHTML = `
                    <div>Base Fee: <strong>$${parseFloat(bill.baseFee).toFixed(2)}</strong></div>
                    <div>Discount (${bill.discountPercent}%): -$${parseFloat(bill.discountAmount).toFixed(2)}</div>
                    <div>GST (12%): +$${parseFloat(bill.gstAmount).toFixed(2)}</div>
                    <div class="font-semibold pt-2 border-t mt-2">Total: $${parseFloat(bill.totalAmount).toFixed(2)}</div>
                    <div class="pt-2">Insurance pays: <span class="text-green-700">$${parseFloat(bill.insuranceAmount).toFixed(2)}</span></div>
                    <div>Patient pays: <span class="text-orange-600">$${parseFloat(bill.coPayAmount).toFixed(2)}</span></div>
                `;
                loadAll();
            } catch (e) { toast(e.message); }
        }

        // Modal
        function openModal(type) {
            const modal = document.getElementById('modal');
            const title = document.getElementById('modal-title');
            const form = document.getElementById('modal-form');
            
            if (type === 'patient') {
                title.textContent = 'Add Patient';
                form.innerHTML = `
                    <input name="firstName" placeholder="First Name" required class="w-full border rounded px-3 py-2 text-sm">
                    <input name="lastName" placeholder="Last Name" required class="w-full border rounded px-3 py-2 text-sm">
                    <input name="dob" placeholder="DOB (MM/DD/YYYY)" required class="w-full border rounded px-3 py-2 text-sm">
                    <input name="binNo" placeholder="Insurance BIN" required class="w-full border rounded px-3 py-2 text-sm">
                    <input name="pcnNo" placeholder="Insurance PCN" required class="w-full border rounded px-3 py-2 text-sm">
                    <input name="memberId" placeholder="Member ID" required class="w-full border rounded px-3 py-2 text-sm">
                `;
                form.onsubmit = async (e) => {
                    e.preventDefault();
                    const f = new FormData(e.target);
                    try {
                        await api('/patients', { method: 'POST', body: JSON.stringify({
                            firstName: f.get('firstName'), lastName: f.get('lastName'), dob: f.get('dob'),
                            insurance: { binNo: f.get('binNo'), pcnNo: f.get('pcnNo'), memberId: f.get('memberId') }
                        })});
                        closeModal(); toast('Patient created'); loadAll();
                    } catch (e) { toast(e.message); }
                };
            } else if (type === 'doctor') {
                title.textContent = 'Add Doctor';
                form.innerHTML = `
                    <input name="firstName" placeholder="First Name" required class="w-full border rounded px-3 py-2 text-sm">
                    <input name="lastName" placeholder="Last Name" required class="w-full border rounded px-3 py-2 text-sm">
                    <input name="npiNo" placeholder="NPI Number" required class="w-full border rounded px-3 py-2 text-sm">
                    <select name="specialty" required class="w-full border rounded px-3 py-2 text-sm">
                        <option value="CARDIO">Cardiology</option>
                        <option value="ORTHO">Orthopedics</option>
                    </select>
                    <input name="practiceStartDate" placeholder="Practice Start (MM/DD/YYYY)" required class="w-full border rounded px-3 py-2 text-sm">
                `;
                form.onsubmit = async (e) => {
                    e.preventDefault();
                    const f = new FormData(e.target);
                    try {
                        await api('/doctors', { method: 'POST', body: JSON.stringify({
                            firstName: f.get('firstName'), lastName: f.get('lastName'), npiNo: f.get('npiNo'),
                            specialty: f.get('specialty'), practiceStartDate: f.get('practiceStartDate')
                        })});
                        closeModal(); toast('Doctor created'); loadAll();
                    } catch (e) { toast(e.message); }
                };
            } else if (type === 'appointment') {
                title.textContent = 'New Appointment';
                form.innerHTML = `
                    <select name="patientId" required class="w-full border rounded px-3 py-2 text-sm">
                        <option value="">Select Patient</option>
                        ${data.patients.map(p => `<option value="${p.id}">${p.firstName} ${p.lastName}</option>`).join('')}
                    </select>
                    <select name="doctorId" required class="w-full border rounded px-3 py-2 text-sm">
                        <option value="">Select Doctor</option>
                        ${data.doctors.map(d => `<option value="${d.id}">Dr. ${d.firstName} ${d.lastName}</option>`).join('')}
                    </select>
                    <input name="appointmentDate" placeholder="Date (MM/DD/YYYY)" required class="w-full border rounded px-3 py-2 text-sm">
                `;
                form.onsubmit = async (e) => {
                    e.preventDefault();
                    const f = new FormData(e.target);
                    try {
                        await api('/appointments', { method: 'POST', body: JSON.stringify({
                            patientId: f.get('patientId'), doctorId: f.get('doctorId'), appointmentDate: f.get('appointmentDate')
                        })});
                        closeModal(); toast('Appointment scheduled'); loadAll();
                    } catch (e) { toast(e.message); }
                };
            }
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
            document.getElementById('modal').classList.remove('flex');
        }
    </script>
</body>
</html>
